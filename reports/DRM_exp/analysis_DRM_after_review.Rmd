---
title: "Analysis after review"
author: "Filip Dechterenko"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

# Load libraries

```{r libraries and preparation}
set.seed(190425)
library(tidyverse); theme_set(theme_classic(16))
library(lme4)
library(here)

source(here("R","utils.R"))
```

# Analysis of protocols

```{r}
prot_dir <- "data/exp_DRM1/protocols/"
fs <- list.files(prot_dir, full.names = T, pattern = "*.csv") %>% str_subset("P000", negate = T)

df_protocols <- fs %>%
  map(~ read_csv(.)) %>% 
  reduce(rbind)

df_protocols$dist_to_target_image <- NA
ix0 <- df_protocols$query == 0 & df_protocols$type == "target"
for (i in 1:nrow(df_protocols)) {
  curr_prot <- df_protocols$prot_id[i]
  curr_grp  <- df_protocols$grp_order[i]
  
  if(df_protocols$type[i] == "target" & df_protocols$query[i] == 1) {
    ix <- ix0 & df_protocols$prot_id == curr_prot & df_protocols$grp_order == curr_grp & df_protocols$img_name == df_protocols$img_name[i]
    stopifnot(sum(ix) == 1)
    df_protocols$dist_to_target_image[i] <-  df_protocols$trial_id[i]-df_protocols$trial_id[ix]
  }
  
  
}

df_prot_cat <- df_protocols %>% select(prot_id, grp_order,category) %>% distinct()

df_prot_cat2 <- df_prot_cat %>% left_join(df_prot_cat, by = "prot_id") %>% filter(category.x == category.y, grp_order.x!=grp_order.y) %>% 
  filter(grp_order.x < grp_order.y)%>% mutate(dist = grp_order.y-grp_order.x)

df_prot_cat2  %>% summarize(m = mean(dist), sd = sd(dist))
df_prot_cat2 %>% ggplot(aes(x = dist)) + geom_histogram()


# df_resp <- df %>% 
#   select(-X31) %>% 
#   filter(query == 1) %>% 
#   select(subject_id = participant, prot_id:corrKey,key_resp = key_resp_4.keys, correct = key_resp_4.corr, rt_key = key_resp_4.rt,
#          confidence = rating.response, confidence.rt = rating.rt, date) %>% 
#   mutate(corrKey = recode(corrKey, left = "old", right = "new"),
#          key_resp = recode(key_resp, left = "old", right = "new")) %>% 
#   filter(!is.na(correct))
#   
# saveRDS(df_resp, file = here("data/exp_DRM1/results_200219.rds"))



```

# Load data

Data were preprocesseb by scripts 

```{r load data, warning=FALSE, message=FALSE}

df <- readRDS(here("data", "exp_DRM1", "results_after_review_200402.rds"))

df_participants <- readxl::read_excel(here::here("data","exp_DRM1","participants_190509.xlsx"))

plots_dir <- here("plots", "exp_DRM1")

if(!dir.exists(plots_dir)) { dir.create(plots_dir) }

df <- df %>% left_join(df_participants, by = c("subject_id"))

```

## Means and SD for confidence

```{r}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
df %>% 
  mutate(confidence_n = factor(confidence, levels = c("not at all sure","somewhat sure","very sure"))) %>% 
  group_by(type) %>% 
  summarise(modus = Mode(confidence),
            mean = mean(as.numeric(confidence_n)),
            sd = sd(as.numeric(confidence_n)),
            median = median(as.numeric(confidence_n)))
```

## Correlation of accuracy with distance to target presentation

```{r}
df_dist_target_images <- 
df %>% left_join(df_protocols %>% 
  select(prot_id, trial_id, grp_order,dist_to_target_image), by = c("prot_id", "trial_id", "grp_order")) 

df_dist_target_images %>% filter(type == "target", query == 1) %>% 
  summarize(m = mean(dist_to_target_image), sd = sd(dist_to_target_image))

df_dist_target_images %>% 
ggplot(aes(x = as.character(correct), y = dist_to_target_image)) + stat_summary(fun.data = "mean_cl_boot")  


p <- df_dist_target_images %>% 
  ggplot(aes(x = dist_to_target_image, y = correct)) + stat_summary(fun.data = "mean_cl_boot") + 
  theme(aspect.ratio = 1) + 
  xlab("Interval between presentations") + 
  ylab("Accuracy")
p
ggsave(file.path(plots_dir, "Figure6xx_target_distance.svg"), p, width = 6, height = 6)
df_dist_target_images %>% 
  filter(dist_to_target_image > 5) %>% 
ggplot(aes(x = dist_to_target_image, y = correct)) + stat_summary(fun.data = "mean_cl_boot")  


df_dist_target_images %>% filter(dist_to_target_image > 5) %>% cor.test(~correct+dist_to_target_image,.)
```

## Average accuracy per image

```{r}
p <- df %>% group_by(type,img_name) %>% 
  summarize(correct = mean(correct, na.rm = T), dist_to_proto = mean(dist_to_proto)) %>% 
  ggplot(aes(x = dist_to_proto, y = correct, col = type)) + 
  geom_point(alpha = 0.2) + stat_smooth(method = "lm") +
  theme(aspect.ratio = 1) + 
  xlab("Distance to visual prototype") + 
  ylab("Accuracy")
p
ggsave(file.path(plots_dir, "FXXScatter.svg"), p, width = 6, height = 6)

```

## Correlation of distance from prototype with accuracy 

As we have for each test scene ditance to prototype and accuracy, we can compute correlation between those variables. I am not sure, whether we can aggregate somehow to get averaged accuracies?

Neverethless, we computed correlations for all scenes, followed by correlation for each type separately. We also show one figure with correlations for each layer.

```{r Correlation of distance from prototype with accuracy }
f <- function(dfx) {
  dfx %>% group_by(img_name) %>% summarize(correct = mean(correct), dist_to_proto = mean(dist_to_proto),dist_to_proto_conv3 = mean(dist_to_proto_conv3),
                                           dist_to_proto_conv5 = mean(dist_to_proto_conv5))  
}
f2 <- function(dfx) {
  dfx %>% group_by(type,img_name) %>% summarize(correct = mean(correct), dist_to_proto = mean(dist_to_proto),dist_to_proto_conv3 = mean(dist_to_proto_conv3),
                                           dist_to_proto_conv5 = mean(dist_to_proto_conv5))  
}

rbind( 
cor.test(~dist_to_proto+correct, df %>% f()) %>% broom::tidy() %>% mutate(layer="fc7", type = "all"),
cor.test(~dist_to_proto+correct, df %>% filter(type == "far distractor") %>% f()) %>% broom::tidy() %>% mutate(layer="fc7", type = "far distractor"),
cor.test(~dist_to_proto+correct, df %>% filter(type == "close distractor") %>% f()) %>% broom::tidy() %>% mutate(layer="fc7", type = "close distractor"),
cor.test(~dist_to_proto+correct, df %>% filter(type == "target") %>% f()) %>% broom::tidy() %>% mutate(layer="fc7", type = "all", type = "target"),
cor.test(~dist_to_proto_conv5+correct, df %>% f()) %>% broom::tidy() %>% mutate(layer="conv5", type = "all"),
cor.test(~dist_to_proto_conv5+correct, df %>% filter(type == "far distractor") %>% f()) %>% broom::tidy() %>% mutate(layer="conv5", type = "far distractor"),
cor.test(~dist_to_proto_conv5+correct, df %>% filter(type == "close distractor") %>% f()) %>% broom::tidy() %>% mutate(layer="conv5", type = "close distractor"),
cor.test(~dist_to_proto_conv5+correct, df %>% filter(type == "target") %>% f()) %>% broom::tidy() %>% mutate(layer="conv5", type = "all", type = "target"),
cor.test(~dist_to_proto_conv3+correct, df %>% f()) %>% broom::tidy() %>% mutate(layer="conv3", type = "all"),
cor.test(~dist_to_proto_conv3+correct, df %>% filter(type == "far distractor") %>% f()) %>% broom::tidy() %>% mutate(layer="conv3", type = "far distractor"),
cor.test(~dist_to_proto_conv3+correct, df %>% filter(type == "close distractor") %>% f()) %>% broom::tidy() %>% mutate(layer="conv3", type = "close distractor"),
cor.test(~dist_to_proto_conv3+correct, df %>% filter(type == "target") %>% f()) %>% broom::tidy() %>% mutate(layer="conv3", type = "all", type = "target")) %>% 
  select(layer, type, estimate, conf.low, conf.high, p.value) %>% 
  knitr::kable(digits = 3, caption ="correlation between accuracy and distance to prototype")

df1 <- df %>% f2() %>% pivot_longer(cols = starts_with("dist_to_proto"),names_to = "layer", values_to = "distance_to_proto")

df1_gr <- df1 %>% 
  group_by(layer, type) %>% 
  do(cor.test(.$distance_to_proto, .$correct) %>% broom::tidy()) %>% 
  ungroup() %>% 
  mutate(layer = recode(layer, dist_to_proto = "fc7", dist_to_proto_conv3 = "conv3", dist_to_proto_conv5 = "conv5")) %>% 
  mutate(layer = factor(layer, levels = c("conv3", "conv5", "fc7"))) 
df1_all <- df1 %>% 
  group_by(layer) %>% 
  do(cor.test(.$distance_to_proto, .$correct) %>% broom::tidy()) %>% 
  ungroup() %>% 
  mutate(layer = recode(layer, dist_to_proto = "fc7", dist_to_proto_conv3 = "conv3", dist_to_proto_conv5 = "conv5")) %>% 
  mutate(layer = factor(layer, levels = c("conv3", "conv5", "fc7"))) %>% 
  mutate(type = "all")
pd <- position_dodge(0.1, seed = 123)
p <- df1_gr %>% 
  arrange(type,layer) %>% 
  ggplot(aes(x = layer, y = estimate, col = type, group = type)) + 
  geom_point(position =  pd)+#position =  position_jitter(width = 0.1, seed = 123)) + 
  geom_line(position =  pd)+#position = position_jitter(width = 0.1, seed = 123)) + 
  geom_linerange(aes(ymin = conf.low, ymax = conf.high),position =  pd)+
  ylab("correlation") +
  ggtitle("Correlation between accuracy and distance to prototype")+
  geom_point(data = df1_all %>% arrange(type,layer), aes(x = layer, y = estimate, group = 1), col = "black") + 
  geom_line(data = df1_all %>% arrange(type,layer), aes(x = layer, y = estimate, group = 1), col = "black") + 
  geom_linerange(data = df1_all %>% arrange(type,layer), aes(ymin = conf.low, ymax = conf.high), col = "black") +
  theme(aspect.ratio = 1)
ggsave(file.path(plots_dir, "FigureXX_layers_correlation.svg"), p, width = 6, height = 6)
```

Figure shows, that correlation is about the same for different layers with exception of far distracators, which decreases with higher layers. Black is for all data

### Distances from tgt images - fc7

## Average distance to target

We can compute distance to targets for each test scene. From these values, we can compute average. Because each layer has different ranges, we normalize the distances by dividint them by distance to the target. Lower values than 1 means, that given scene type is closer to targets than targets themselves (e.g. their are more in center).

```{r}
gt0 <- function(x) {x >0}

df2 <- df %>% pivot_longer(cols = starts_with("dist_to_tgts"), names_to = "layer", values_to = "distance_to_targets")
df2_dist_tgt <- df %>% pivot_longer(cols = starts_with("avg_dist_between_tgts"), names_to = "layer", values_to = "avg_dist_between_tgts")

df2 <- df2 %>% left_join(df2_dist_tgt %>% select(subject_id,trial_id), by = c("subject_id", "trial_id"))

df2_tgt <- df2 %>% 
  rowwise() %>% 
  mutate(mean_tgt_dist = unlist(distance_to_targets) %>% mean(),
         min_tgt_dist = unlist(distance_to_targets) %>% min(),
         min_tgt_dist_no0 = unlist(distance_to_targets) %>% Filter(gt0,.) %>% min())

df2_tgt_agg1 <- df2_tgt %>% 
    mutate(layer = recode(layer, dist_to_tgts = "fc7", dist_to_tgts_conv3 = "conv3", dist_to_tgts_conv5 = "conv5")) %>% 
    mutate(layer = factor(layer, levels = c("conv3", "conv5", "fc7"))) 

df2_tgt_agg1 %>% 
  ungroup() %>% 
  filter(layer == "fc7") %>% 
  group_by(img_name,type) %>% 
  summarize(correct = mean(correct),  min_tgt_dist_no0 = mean(min_tgt_dist_no0)) %>% 
  ggplot(aes(x = min_tgt_dist_no0, y = correct, col = type)) +
  geom_point(alpha = 0.2) + stat_smooth(method = "lm") +
  theme(aspect.ratio = 1) + 
  xlab("Minimum distance to target (0 exlucded)") + 
  ylab("Accuracy") 

df2_tgt_agg1 %>% 
  ungroup() %>% 
  filter(layer == "conv5") %>% 
  group_by(img_name,type) %>% 
  summarize(correct = mean(correct),  min_tgt_dist_no0 = mean(min_tgt_dist_no0), dist_to_proto = mean(dist_to_proto)) %>% 
  ggplot(aes(x = min_tgt_dist_no0, y = correct, col = type)) +
  geom_point(alpha = 0.2) + stat_smooth(method = "lm") +
  theme(aspect.ratio = 1) + 
  xlab("Minimum distance to target (0 exlucded)") + 
  ylab("Accuracy") 

df2_tgt_agg1 %>% 
  ungroup() %>% 
  filter(layer == "fc7") %>% 
  group_by(img_name) %>% 
  summarize(correct = mean(correct),  min_tgt_dist_no0 = mean(min_tgt_dist_no0), dist_to_proto = mean(dist_to_proto)) %>% 
  cor.test(~min_tgt_dist_no0+dist_to_proto,.)

df2_tgt_agg1 %>% 
  ungroup() %>% 
  filter(layer == "fc7") %>% 
  group_by(img_name) %>% 
  summarize(correct = mean(correct),  min_tgt_dist_no0 = mean(min_tgt_dist_no0), dist_to_proto = mean(dist_to_proto)) %>% 
  cor.test(~correct+dist_to_proto,.)
df2_tgt_agg1 %>% 
  ungroup() %>% 
  filter(layer == "fc7") %>% 
  group_by(img_name,type) %>% 
  summarize(correct = mean(correct),  min_tgt_dist_no0 = mean(min_tgt_dist_no0), dist_to_proto = mean(dist_to_proto)) %>% 
  group_by(type) %>% 
  do(cor.test(~correct+dist_to_proto,.) %>% broom::tidy())


p <- df2_tgt_agg1 %>% 
    ungroup() %>% 
    filter(layer == "fc7") %>% 
    group_by(img_name,type) %>% 
    summarize(correct = mean(correct),  min_tgt_dist_no0 = mean(min_tgt_dist_no0), dist_to_proto = mean(dist_to_proto)) %>%
  ggplot(aes(x = dist_to_proto, y = min_tgt_dist_no0, col = type)) + 
  geom_point() + 
  theme(aspect.ratio = 1) +
  xlab("Distance to visual prototype") + 
  ylab("Minimum distance to target (0 exlucded)")
p
ggsave(file.path(plots_dir, "FigureXXDistances_right.svg"), p, width = 6, height = 6)



```

## Minimum distance to target

Alternativelly, we can compute minimum distance of presented scene to one of the targets. We are removing zero distances, as in case of target queries, this minimum would be 0.

```{r Min distance to target}
df2_tgt_agg2_ci <- df2_tgt_agg1 %>% 
  group_by(layer,type) %>% 
  summarize(m=Hmisc::smean.cl.boot(min_tgt_dist_no0)[1],lower =Hmisc::smean.cl.boot(min_tgt_dist_no0)[2], upper = Hmisc::smean.cl.boot(min_tgt_dist_no0)[3])

df2_tgt_agg2_ci %>% 
  group_by(layer) %>% 
  mutate(m = m/m[type=="target"]) %>% 
  ggplot(aes(x=layer, y=m,col = type, group = type)) + 
  geom_point()+geom_line() +
  ggtitle("Minimum distance to targets (identities excluded)")

```

Figure shows that types of images get closer to each other in lower layers.


```{r select examples}

set.seed(19763) 
df_names <- df %>% filter(subject_id == 1, grp_order == 3) %>% group_by(type) %>% sample_n(5)

df %>% filter(img_name %in% df_names$img_name) %>% 
  group_by(type) %>% 
  summarize(correct = mean(correct))
```

## Compare to category center

```{r Compare to category center}
cr <- df %>% rename(dist_to_proto_fc7 = dist_to_proto) %>% select(starts_with("dist_to_proto"),starts_with("dist_to_cat_center"), correct, img_name) %>% 
  group_by(img_name) %>% 
  summarize_each(mean) %>% 
  ungroup() %>% 
  select(-img_name) %>% 
  as.matrix() %>% 
  Hmisc::rcorr()

cr$r

cr_close <- df %>% rename(dist_to_proto_fc7 = dist_to_proto) %>% 
  filter(type == "close distractor") %>% 
  select(starts_with("dist_to_proto"),starts_with("dist_to_cat_center"), correct, img_name) %>% 
  group_by(img_name) %>% 
  summarize_each(mean) %>% 
  ungroup() %>% 
  select(-img_name) %>% 
  as.matrix() %>% 
  Hmisc::rcorr()

cr_close$r %>% knitr::kable(digits = 2)

cr_targets <- df %>% rename(dist_to_proto_fc7 = dist_to_proto) %>% 
  filter(type == "target") %>% 
  select(starts_with("dist_to_proto"),starts_with("dist_to_cat_center"), correct, img_name) %>% 
  group_by(img_name) %>% 
  summarize_each(mean) %>% 
  ungroup() %>% 
  select(-img_name) %>% 
  as.matrix() %>% 
  Hmisc::rcorr()

cr_targets$r %>% knitr::kable(digits = 2)

p <- df %>% group_by(type,img_name) %>% 
  summarize(correct = mean(correct, na.rm = T), dist_to_cat_center_fc7 = mean(dist_to_cat_center_fc7)) %>% 
  ggplot(aes(x = dist_to_cat_center_fc7, y = correct, col = type)) + 
  geom_point(alpha = 0.2) + stat_smooth(method = "lm") +
  theme(aspect.ratio = 1) + 
  xlab("Distance to visual prototype") + 
  ylab("Accuracy")
p
```

## Model Distance to targets 


```{r}
df$dist_to_tgts <- purrr::map2(df$dist_to_tgts, df$avg_dist_between_tgts, ~.x/.y) # normalize distances



dist_vals_targets <- df %>% 
  filter(type == "target") %>% 
  pull(dist_to_tgts) %>% 
  unlist() 

dist_vals_close_dist <- df %>% 
  filter(type == "close distractor") %>% 
  pull(dist_to_tgts) %>% 
  unlist() 
  
dist_vals_far_dist <- df %>% 
  filter(type == "far distractor") %>% 
  pull(dist_to_tgts) %>% 
  unlist() 

df_dist_vals <- tibble(type = c(rep("target", length(dist_vals_targets)),
                                rep("close distractor", length(dist_vals_close_dist)),
                                rep("far distractor", length(dist_vals_far_dist))),
                       value = c(dist_vals_targets, dist_vals_close_dist, dist_vals_far_dist)) %>% 
  filter(value > 0)

df_dist_vals %>% 
  ggplot(aes(x = value, col = type)) + geom_freqpoly()

df$model_dist_tgt_02 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<0.2)) # normalize distances
df$model_dist_tgt_03 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<0.3)) # normalize distances
df$model_dist_tgt_04 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<0.4)) # normalize distances
df$model_dist_tgt_05 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<0.5)) # normalize distances
df$model_dist_tgt_06 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<0.6)) # normalize distances
df$model_dist_tgt_07 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<0.7)) # normalize distances
df$model_dist_tgt_08 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<0.8)) # normalize distances
df$model_dist_tgt_09 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<0.9)) # normalize distances
df$model_dist_tgt_1 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<1)) # normalize distances
df$model_dist_tgt_12 <- purrr::map_dbl(df$dist_to_tgts, ~any(.x<1.2)) # normalize distances


dfx <- df %>% 
  pivot_longer(cols = starts_with("model_dist_tgt"), names_to = "model", values_to = "accuracy") %>% 
  mutate(accuracy = if_else(type == "target",accuracy, 1-accuracy)) 

dfx %>% 
  ggplot(aes(x = type, y = accuracy, col = model, group = model)) + 
  stat_summary(fun.data = "mean_cl_boot") + 
  stat_summary(fun.y = "mean", geom = "line") 

dfx %>% 
  group_by(img_name, model, type) %>% 
  summarize(correct = mean(correct), accuracy = mean(accuracy)) %>% 
  mutate(accuracy = jitter(accuracy)) %>% 
  group_by(model, type) %>% 
  do(cor.test(~accuracy+correct,.) %>% broom::tidy()) %>% 
  filter(type == "close distractor")
  
```

## Divide distractors by distance to targets - min no0

```{r}
divide_into_groups_tgt_dist <- function(dfxx) {
  
  dfxx_notgt <- dfxx %>% filter(type != "target") %>% mutate(model_type = NA)
  
  rnk <- rank(dfxx_notgt$min_tgt_dist)
  
  dfxx_notgt$model_type[rnk <= 5] <- "close_tgt"
  dfxx_notgt$model_type[rnk > 5]  <- "far_tgt"
  
  dfxx %>% 
    left_join(dfxx_notgt %>% select(img_name,model_type), by="img_name") %>% 
    mutate(model_type = if_else(type == "target","target",model_type))
}

df2_tgt <- df2_tgt %>% ungroup() %>% distinct()
df2_tgt_modeldist <- df2_tgt %>% 
  filter(layer == "dist_to_tgts") %>% 
  group_by(subject_id,grp_order) %>% 
  do(divide_into_groups_tgt_dist(.))

df2_tgt_modeldist %>% xtabs(~type+model_type,.) %>% prop.table(1)
df2_tgt_modeldist %>% filter(type!="target") %>% xtabs(~type+model_type,.) %>% psych::phi()
df2_tgt_modeldist %>% filter(type != "target") %>% 
  group_by(model_type) %>% 
  summarize(correct = mean(correct))

df2_tgt_modeldist %>% filter(type != "target") %>% 
  group_by(type) %>% 
  summarize(correct = mean(correct))

```

## Divide distractors by memorability

```{r}
df_perimage <- df %>% group_by(img_name,type) %>% summarize(m = mean(correct), sd = sd(correct)) %>% arrange(-m)
mem_imgnames <- read_csv(here("data/exp_DRM1/memorability/memorability_imgnames.txt"), col_names = F)
mem_values <- read_csv(here("data/exp_DRM1/memorability/memorability_all.txt"), col_names = F)

df_mem <- tibble(img_name = mem_imgnames$X1, mem_score = mem_values$X1)
dfm <- df %>% left_join(df_mem,by = "img_name") 


divide_into_groups_memorability <- function(dfxx) {
  
  dfxx_notgt <- dfxx %>% filter(type != "target") %>% mutate(model_type = NA)
  
  rnk <- rank(dfxx_notgt$mem_score)
  
  dfxx_notgt$model_type[rnk <= 5] <- "low memorability"
  dfxx_notgt$model_type[rnk > 5]  <- "high memorability"
  
  dfxx %>% 
    left_join(dfxx_notgt %>% select(img_name,model_type), by="img_name") %>% 
    mutate(model_type = if_else(type == "target","target",model_type))
}


df2_modelmem <- dfm %>% 
  group_by(subject_id,grp_order) %>% 
  do(divide_into_groups_memorability(.))

df2_modelmem %>% xtabs(~type+model_type,.) %>% prop.table()
df2_modelmem %>% filter(type!="target") %>% xtabs(~type+model_type,.) %>% psych::phi()

df2_modelmem %>% filter(type != "target") %>% 
  group_by(model_type) %>% 
  summarize(correct = mean(correct))


```

## Divide distractors by fc7

```{r}

divide_into_groups_dist_to_proto <- function(dfxx) {
  
  dfxx_notgt <- dfxx %>% filter(type != "target") %>% mutate(model_type = NA)
  
  rnk <- rank(dfxx_notgt$dist_to_proto)
  
  dfxx_notgt$model_type[rnk <= 5] <- "close_to_prototype"
  dfxx_notgt$model_type[rnk > 5]  <- "far_to_prototype"
  
  dfxx %>% 
    left_join(dfxx_notgt %>% select(img_name,model_type), by="img_name") %>% 
    mutate(model_type = if_else(type == "target","target",model_type))
}


df2_modeldisttoproto <- df %>% 
  group_by(subject_id,grp_order) %>% 
  do(divide_into_groups_dist_to_proto(.))

df2_modeldisttoproto %>% xtabs(~type+model_type,.)
df2_modeldisttoproto %>% filter(type!="target") %>% xtabs(~type+model_type,.) %>% psych::phi()

df2_modeldisttoproto %>% filter(type != "target") %>% 
  group_by(model_type) %>% 
  summarize(correct = mean(correct))


```

## Divide distractors by conv3

```{r}

divide_into_groups_dist_to_proto_conv3 <- function(dfxx) {
  
  dfxx_notgt <- dfxx %>% filter(type != "target") %>% mutate(model_type = NA)
  
  rnk <- rank(dfxx_notgt$dist_to_proto_conv3)
  
  dfxx_notgt$model_type[rnk <= 5] <- "close_tgt"
  dfxx_notgt$model_type[rnk > 5]  <- "far_tgt"
  
  dfxx %>% 
    left_join(dfxx_notgt %>% select(img_name,model_type), by="img_name") %>% 
    mutate(model_type = if_else(type == "target","target",model_type))
}


df2_modeldisttoproto3 <- df %>% 
  group_by(subject_id,grp_order) %>% 
  do(divide_into_groups_dist_to_proto_conv3(.))

df2_modeldisttoproto3 %>% xtabs(~type+model_type,.)
df2_modeldisttoproto3 %>% filter(type!="target") %>% xtabs(~type+model_type,.) %>% psych::phi()

df2_modeldisttoproto3 %>% filter(type != "target") %>% 
  group_by(model_type) %>% 
  summarize(correct = mean(correct))

df2_tgt_modeldist %>% filter(type != "target") %>% 
  group_by(type) %>% 
  summarize(correct = mean(correct))

```

## Divide distractors by conv5

```{r}

divide_into_groups_dist_to_proto_conv5 <- function(dfxx) {
  
  dfxx_notgt <- dfxx %>% filter(type != "target") %>% mutate(model_type = NA)
  
  rnk <- rank(dfxx_notgt$dist_to_proto_conv5)
  
  dfxx_notgt$model_type[rnk <= 5] <- "close_tgt"
  dfxx_notgt$model_type[rnk > 5]  <- "far_tgt"
  
  dfxx %>% 
    left_join(dfxx_notgt %>% select(img_name,model_type), by="img_name") %>% 
    mutate(model_type = if_else(type == "target","target",model_type))
}


df2_modeldisttoproto5 <- df %>% 
  group_by(subject_id,grp_order) %>% 
  do(divide_into_groups_dist_to_proto_conv5(.))

df2_modeldisttoproto5 %>% filter(type!="target") %>% xtabs(~type+model_type,.) %>% prop.table(1)
df2_modeldisttoproto5 %>% filter(type!="target") %>% xtabs(~type+model_type,.) %>% psych::phi()

df2_modeldisttoproto5 %>% filter(type != "target") %>% 
  group_by(model_type) %>% 
  summarize(correct = mean(correct))

df2_tgt_modeldist %>% filter(type != "target") %>% 
  group_by(type) %>% 
  summarize(correct = mean(correct))

```

### Ranking of images to category center

```{r}

cor.test(~ dist_to_cat_center_fc7+ dist_to_cat_center_conv5, df)
cor.test(~ dist_to_cat_center_fc7+ dist_to_cat_center_conv3, df)

cor.test(~ dist_to_cat_center_fc7+ dist_to_proto, df)
cor.test(~ dist_to_cat_center_conv5+ dist_to_proto_conv5, df)
cor.test(~ dist_to_cat_center_conv3+ dist_to_proto_conv3, df)
```


### Compare models

```{r}
df2_modelmem1 <- 
  df2_modelmem %>% 
    ungroup() %>% 
    select(subject_id, trial_id, category_centroid_type = type, memorability_model =model_type, correct, category)

df2_modeldisttoproto31 <- 
  df2_modeldisttoproto3  %>% 
    ungroup() %>% 
    select(subject_id, trial_id, dist_to_proto3 =model_type, correct, category) 

df2_modeldisttoproto51 <- 
  df2_modeldisttoproto5  %>% 
    ungroup() %>% 
    select(subject_id, trial_id, dist_to_proto5 =model_type, correct, category) 
    
df2_tgt_modeldist1 <- 
  df2_tgt_modeldist  %>% 
    ungroup() %>% 
    select(subject_id, trial_id, min_dist_to_tgt =model_type, correct, category) 
df_models_res <- df2_modelmem1 %>% 
  left_join(df2_modeldisttoproto31, by = c("subject_id", "trial_id", "correct","category")) %>% 
  left_join(df2_modeldisttoproto51, by = c("subject_id", "trial_id", "correct","category")) %>% 
  left_join(df2_tgt_modeldist1, by = c("subject_id", "trial_id", "correct","category")) %>% 
  filter(category_centroid_type != "target")

df_models_res_longer <- df_models_res %>% 
  pivot_longer(cols = c(category_centroid_type, min_dist_to_tgt, dist_to_proto5, dist_to_proto3, memorability_model)) 
  
XXtab <- df_models_res_longer %>% 
  group_by(name,value) %>% 
  summarize(FA = sprintf("%.2f", mean(1-correct)))

XXtab

glmm_null_model <- df_models_res %>% glmer(correct~1+(1|subject_id) + (1|category), ., family = binomial())

glmm_orig_model <- df_models_res %>% glmer(correct~category_centroid_type+(1+category_centroid_type|subject_id) + (1|category), ., family = binomial())
glmm_dist_to_tgt <- df_models_res %>% glmer(correct~min_dist_to_tgt + (1+min_dist_to_tgt|subject_id) + (1|category),., family = binomial())
glmm_dist_to_proto_conv5 <- df_models_res %>% glmer(correct~dist_to_proto5 + (1+dist_to_proto5|subject_id) + (1|category),., family = binomial())
glmm_dist_to_proto_conv3 <- df_models_res %>% glmer(correct~dist_to_proto3 + (1+dist_to_proto3|subject_id) + (1|category),., family = binomial())
glmm_memorability <- df_models_res %>% glmer(correct~memorability_model + (1+memorability_model|subject_id) + (1|category),., family = binomial())
models_list <- list(glmm_null_model,glmm_orig_model,glmm_dist_to_tgt,glmm_dist_to_proto_conv3,glmm_dist_to_proto_conv5,glmm_memorability)
models_list %>% 
  map(performance::r2_nakagawa) %>%
  map_dbl("R2_conditional") %>% 
  round(2)

models_list %>% 
  map(performance::r2_nakagawa) %>%
  map_dbl("R2_marginal") %>% 
  round(2)

models_list %>% 
  map_dbl(AIC)
```

## Context entropy

```{r}
cont_entropy <- read_csv(here("data/exp_DRM1/cats_entrophy.csv"), col_names = F) %>% rename(category = X1, cont_entropy = X2) %>% mutate(category = str_replace(category, "_", " "))
df_cont_entropy <- df %>% left_join(cont_entropy, by = "category") 
p <- df_cont_entropy %>% 
  mutate(FA = 1 - correct) %>% 
  filter(type != "target") %>% 
  ggplot(aes(x = category, y = FA, col = type, group = type)) + 
  stat_summary(fun.data = "mean_cl_boot") + 
  stat_summary(fun = "mean", geom = "line") + 
  
  scale_x_discrete(guide = guide_axis(n.dodge=3))

ggsave(file.path(plots_dir, "Figurexx_categories_FA.svg"), p, width = 12, height = 6)

df_cont_entropy %>% 
  filter(type != "target") %>% 
  group_by(category,type) %>% 
  summarize(FA = mean(1-correct), cont_entropy = mean(cont_entropy)) %>% 
  group_by(category) %>% 
  summarize(diff_FA = FA[type == "close distractor"]-FA[type == "far distractor"],
            cont_entropy = mean(cont_entropy)) %>% 
  ggplot(aes(x = diff_FA, y = cont_entropy, label = category)) +
  geom_point()+
  ggrepel::geom_label_repel()

p <- df_cont_entropy %>% 
  filter(type == "close distractor") %>% 
  group_by(category) %>% 
  summarize(FA = mean(1-correct), cont_entropy = mean(cont_entropy)) %>% 
  ggplot(aes(x = cont_entropy, y = FA, label = category)) +
  geom_point()+
  ggrepel::geom_label_repel()  + 
  ggtitle("Close distractors") +
  ylab("FA") + 
  xlab("context entropy") +
  stat_smooth(method = "lm")
p
df_cont_entropy %>% 
  filter(type == "close distractor") %>% 
  group_by(category) %>% 
  summarize(FA = mean(1-correct), cont_entropy = mean(cont_entropy)) %>% 
  cor.test(~FA+cont_entropy,., method = "sp")

df_cont_entropy %>% 
  filter(type == "far distractor") %>% 
  group_by(category) %>% 
  summarize(FA = mean(1-correct), cont_entropy = mean(cont_entropy)) %>% 
  cor.test(~FA+cont_entropy,., method = "sp")

ggsave(file.path(plots_dir, "Figurexx_categories_close_dist_CE.svg"), p, width = 6, height = 6)
df_cont_entropy %>% 
  filter(type == "far distractor") %>% 
  group_by(category) %>% 
  summarize(FA = mean(1-correct), cont_entropy = mean(cont_entropy)) %>% 
  ggplot(aes(x = FA, y = cont_entropy, label = category)) +
  geom_point()+
  ggrepel::geom_label_repel() + 
  ggtitle("Far distractors")

```

## FAbility

```{r}
df_dist <- df %>% filter(type != "target") %>% group_by(type, img_name) %>% 
  summarize(FA = mean(1-correct), dist_to_cat_center_fc7 = mean(dist_to_cat_center_fc7), dist_to_proto_conv3 = mean(dist_to_proto_conv3), dist_to_proto_conv5 = mean(dist_to_proto_conv5)) %>% ungroup()
df_dist %>% select(-type,-img_name) %>% 
  as.matrix() %>% 
  Hmisc::rcorr(type = "spearman")

df_dist %>% ggplot(aes(x = dist_to_proto_conv3, y = FA, col =type)) + geom_point() + stat_smooth( method = "lm")

df_dist %>% select(-type,-img_name) %>% 
  as.matrix() %>% 
  Hmisc::rcorr()
df_dist %>% ggplot(aes(x = dist_to_proto_conv5, y = FA, col =type)) + geom_point() + stat_smooth( method = "lm")


df2_tgt_corr <- df2_tgt %>% distinct() %>% filter(type != "target") %>% group_by(layer, type, img_name) %>% 
  summarize(FA = mean(1-correct), dist_to_tgt = mean(min_tgt_dist_no0)) %>% ungroup()

df2_tgt_corr %>% filter(layer == "dist_to_tgts") %>% 
  select(-type,-img_name,-layer) %>% 
  as.matrix() %>% 
  Hmisc::rcorr(type = "sp")

df2_tgt_corr %>% filter(layer == "dist_to_tgts_conv3") %>% 
  select(-grp_order,-layer) %>% 
  group_by(type) %>% 
  do(cor.test(~FA+dist_to_tgt,.) %>% broom::tidy())
  as.matrix() %>% 
  Hmisc::rcorr(type = "sp")
  

dfm %>%  filter(type != "target") %>% group_by(type, img_name) %>% 
  summarize(FA = mean(1-correct), mem_score = mean(mem_score))  %>% 
  ggplot(aes(x = mem_score, y = FA, col =type)) + geom_point() + stat_smooth( method = "lm")

dfm %>% filter(type != "target") %>% group_by(type, img_name) %>%
    summarize(FA = mean(1-correct), mem_score = mean(mem_score))  %>% 
  cor.test(~FA+mem_score,.)
  
```

## Hits and FAs

```{r}
df_hits <- df %>% 
    filter(type == "target") %>% 
  group_by(category) %>% 
  summarize(H = mean(correct))

df_fas <- df %>% 
    filter(type == "close distractor") %>% 
  group_by(category) %>% 
  summarize(FA = mean(1-correct))
df_hits %>% left_join(df_fas) %>% ggplot(aes(x = H, y = FA, label = category)) +
  geom_point()+
  ggrepel::geom_label_repel()
df_hits %>% left_join(df_fas) %>% cor.test(~H+FA,., method = "sp")

df_hits %>% left_join(df_fas) %>% filter(category!="badlands") %>% ggplot(aes(x = H, y = FA, label = category)) +
  geom_point()+
  ggrepel::geom_label_repel()

df_hits <- df %>% 
    filter(type == "target") %>% 
  group_by(category) %>% 
  summarize(H = mean(correct))

df_fas_far <- df %>% 
    filter(type == "far distractor") %>% 
  group_by(category) %>% 
  summarize(FA = mean(1-correct))

df_hFA_close <- df_hits %>% left_join(df_fas)
df_hFA_far <- df_hits %>% left_join(df_fas_far)

df_hFA_close %>% filter(category!="badlands") %>% cor.test(~H+FA,.,method ="sp")
df_hFA_close %>% cor.test(~H+FA,.,method ="sp")
df_hFA_far %>% cor.test(~H+FA,.,method ="sp")
```

## FAbility - with category corrections

```{r}
df

```

